WARNING: Contains **very imperative and ugly code**. Do not read!!!
